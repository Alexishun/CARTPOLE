clc; clear all; close all;
N=40;
tf=1;
Dt=tf/N;
n=4;%cantidad de estados
m=1;%cantidad de inputs
Z0=zeros(N*(m+n),1);
options = optimoptions(@fmincon,'MaxFunctionEvaluations',120000)
[zmin,valmin]=fmincon(@(x)Objet(x),Z0,[],[],[],[],@(x)restr(x),options)
X=zmin(1:N*n);
U=zmin(N*n+1:end);
save('XUtraj_quad','X','U')   % Guardamos para hacer linealizacion

figure(1)
plot(X(1:n:end),'o-');hold on;% posicion x
plot(X(3:n:end),'o-');hold on;% velocidad x
legend('pos x','vel x')
title('Cartpole x')
figure(2)
plot(X(2:n:end),'o-');hold on;% posicion x
plot(X(4:n:end),'o-');hold on;% velocidad x
legend('pos th','vel th')
title('Cartpole th')
figure(3)
plot(U(1:end),'o-');hold on;
legend('u1')
%%
%close all
figure(4)
pause(3)
for i=1:N
    x=X(1+6*(i-1));
    y=X(2+6*(i-1));
    th=X(3+6*(i-1));
    plot(x+[-0.2*cos(th) 0.2*cos(th)],y+[-0.2*sin(th) 0.2*sin(th)],'ro-');hold on;grid on;
    %plot([0.5 0.5],[-0.2 10],'k','LineWidth',2);
    plot([0.5 0.5],[-10 0.2],'k','LineWidth',2)
    axis([-1.5 1.5 -1.5 1.5])
    drawnow;
    %pause(0.1);
    %clf;
end

function J=Objet(z)
    n=4;
    m=1;
    N=40;
    X=z(1:N*n); 
    U=z(N*n+1:end); 
    Q=1000;
    R=0.5;
    Qlinx=1;
    Qf=diag([100;10000;1;1]);
    R=0.00001*eye(2);
    J1=(X(end-3:end)-[0;pi;0;0])'*Qf*(X(end-3:end)-[0;pi;0;0]);% ultimos 4 valores
    J2cost=0;
    for k=1:N
        J2cost=J2cost+U(k)'*R*U(k);
    end
    for k=1:N
        J1=J1+(X(4*k-3)-k/N)'*Qlinx*(X(4*k-3)-k/N);
    end
    J=J1+J2cost;
end

function [c,ceq]=restr(z)
    x0=zeros(4,1);
    tf=1;
    N=40;
    n=4;
    X=z(1:N*n);
    U=z(N*n+1:end);
    Dt=tf/N;
    umax=10;
    c=zeros(2*N,1);
    for k=1:N
        %c([4*k-3:4*k],1)=[U(2*k-1:2*k)-umax;-U(2*k-1:2*k)+umin];
    end
    for k=1:N
        %c=[c;X(2+6*(k-1))+0.2*sin(X(3+6*(k-1)))+0.2];%cola adelante
        %c=[c;X(2+6*(k-1))-0.2*sin(X(3+6*(k-1)))+0.2];%cola atras
        c=[c; X(1+4*(k-1))-20]; %
        c=[c;-X(1+4*(k-1))+20]; %
    end
    % for k=1:N
    %     c=[c;X(2+6*(k-1))+0.2*sin(X(3+6*(k-1)))-0];%cola adelante
    %     c=[c;X(2+6*(k-1))-0.2*sin(X(3+6*(k-1)))-0];%cola atras
    % end
    %x(k+1)=x(k)+Dt*f(x(k),u(k))
    %x_1=x_0+Dt*f(x_0,u_0) 2 ecuaciones
    ceqDYN=zeros(n*N,1);
    ceqDYN(1:4,1)=[-X(1:4)+x0+Dt*cartpole(x0,U(1))];
    for k=2:N
        ceqDYN([4*k-3:4*k],1)=-X([4*k-3:4*k])+X([4*k-7:4*k-4])+Dt*cartpole(X([4*k-7:4*k-4]),U(k));
    end

    ceqADD=[];
    ceq=[ceqDYN;ceqADD];

end

function dxdt=cartpole(x,u)
    q1=x(1);q2=x(2);dq1=x(3);dq2=x(4);
    dxdt=[x(3);
        x(4);
        -(16223716305996143228856941593733918223313978259750847597453740499058966678620248022049014759971940856466741823947172811168830095773108008671715193696591604077507306884501765881856*u - 196554677492599817310625975238981747599583093429257899951115641218968349161216696074997000417787820163681650600778681324546049244814550114497801293037754552962477820359982710784*dq2^2*sin(q2) - 29226576193072775502131933984168887221002846417938597662205537337127636202449480214025575584510686002514985502222925963927787483674484635500281856*u*cos(q2)^2 + 12355856081458749631593798994117033587757552564373303703586477395784264302577103087130549838008502088935690089400744716853177865559350981043569844581280932756242268292309822996480*cos(q2)*sin(q2))/(1259516420128312874662177356719308964019435067959928124618646128121428272516634639757384981743687475488625180824890620259776126812876084539531615033124366487020503927514726400000*cos(q2)^2 - 8823076800140183443710499287030456772306261827129359274645360228237219880944172111053145853733040756324162083791856201424821854863697509040588922091209003780550129660565913600000)
                                                                                                                                                                      -(- 403045254441060119891896754150178868486219221747176999877966760998857047205323084722363194157979992156360057863964998483128360580120347052650116810599797275846561256804712448*cos(q2)*sin(q2)*dq2^2 + 177484117545531906445310158699520485059992073680635253502587444077940167071296698676877483043092463335843216439067300112885721712312987152200581497525730322753811912583825850368*sin(q2) + 33267546465669726301061291729218220909263489511068281399194322512810120426661210800939679896648430187181000287535107227432812019263258505494613459046420901071127838720000000000*u*cos(q2))/(403045254441060119891896754150178868486219221747176999877966760998857047205323084722363194157979992156360057863964998483128360580120347052650116810599797275846561256804712448*cos(q2)^2 - 2823384576044858701987359771849746167138003784681394967886515273035910361902135075537006673194573042023731866813393984455942993556383202892988455069186881209776041491381092352)
 end